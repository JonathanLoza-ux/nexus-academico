<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus - Asistente IA</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <div class="app-container">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand-container">
                    <i class="fas fa-brain logo-icon"></i>
                    <h2>NEXUS</h2>
                </div>
                <button class="theme-btn-header" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>

            <a href="#" class="new-chat-btn" onclick="nuevaConversacionInstant(); return false;">
                <i class="fas fa-plus"></i> Nueva Conversaci√≥n
            </a>

            <div class="conversations-list">
                <p class="section-title">HISTORIAL</p>
                {% for chat in conversations %}
                <div class="chat-item-wrapper" id="chat-item-{{ chat.id }}">
                    <a href="{{ url_for('home', chat_id=chat.id) }}" class="chat-item {% if active_chat and active_chat.id == chat.id %}active{% endif %}">
                        <i class="far fa-comment-alt"></i>
                        <span>{{ chat.title }}</span>
                    </a>
                    <button class="delete-chat-btn" onclick="borrarChat(event, {{ chat.id }})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                {% endfor %}
            </div>

            <div class="sidebar-footer">
                <button class="explore-btn" onclick="toggleModal('subjectsModal')">
                    <i class="fas fa-compass"></i> Explorar Categor√≠as
                </button>
                <div class="copyright-text">¬© 2026 Jonathan Loza</div>
            </div>
        </aside>

        <main class="chat-area" data-user-name="{{ name.split()[0] }}">
            <header class="chat-header">
                <button id="menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <h3 class="app-title">Asistente Virtual</h3>
                
                <div class="user-profile-area profile-dropdown" onclick="toggleDropdown()">
                    <div class="profile-pic-placeholder">
                        {{ name[0] | upper }}
                    </div>
                    
                    <div id="myDropdown" class="dropdown-content">
                        <div class="dropdown-header-info">
                            <strong>{{ name }}</strong>
                            <small>{{ email }}</small>
                        </div>
                        <a href="https://wa.me/50364254348" target="_blank">
                            <i class="fab fa-whatsapp" style="color: #25D366;"></i> Soporte T√©cnico
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{{ url_for('logout') }}" style="color: #ef4444;">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                        </a>
                    </div>
                </div>
            </header>

            <div id="chat-box">
                {% if not chat_history %}
                <div class="empty-state">
                    <div class="logo-big"><i class="fas fa-brain"></i></div>
                    <h2>¬°Hola, {{ name.split()[0] }}!</h2>
                    <p>¬øQu√© quieres aprender hoy?</p>
                    <div class="suggestion-chips">
                        <button onclick="usarPrompt('Ay√∫dame con Matem√°ticas')">üìê Matem√°ticas</button>
                        <button onclick="usarPrompt('Expl√≠came un tema de Historia')">üèõÔ∏è Historia</button>
                        <button onclick="usarPrompt('Ay√∫dame a programar en Python')">üíª Programaci√≥n</button>
                    </div>
                </div>
                {% endif %}

                {% for msg in chat_history %}
                    <div class="message {{ msg.sender }}-msg">
                        <div class="msg-content">
                            {% if msg.has_image %}
                            <div class="img-badge"><i class="fas fa-image"></i> Imagen enviada</div>
                            {% endif %}
                            <span class="history-content" style="display:none;">{{ msg.content }}</span>
                            <div class="rendered-text">Cargando...</div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div id="loading-indicator" class="hidden">
                <i class="fas fa-circle-notch fa-spin"></i> Nexus est√° pensando...
            </div>

            <div id="image-preview-container" class="hidden">
                <img id="image-preview" src="" alt="Vista previa">
                <button class="close-preview-btn" onclick="quitarImagen()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- ‚úÖ INPUT AREA CORREGIDO - SIN BOT√ìN ATTACH, CON DIV CERRADO CORRECTAMENTE -->
            <div id="input-area">
                <input type="hidden" id="current-chat-id" value="{{ active_chat.id if active_chat else '' }}">

                <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="mostrarVistaPrevia()">

                <!-- ‚úÖ BOT√ìN + MODOS -->
                <div class="mode-plus" id="modePlus">
                    <button type="button" class="mode-plus-btn" id="modePlusBtn" title="Modo de respuesta">
                        <i class="fas fa-plus"></i>
                    </button>

                    <div class="mode-plus-panel" id="modePlusPanel">
                        <div class="mode-plus-title">Modo de respuesta</div>

                        <button type="button" class="mode-plus-action"
                            onclick="closeModePlus(); document.getElementById('image-input').click()">
                            <i class="fas fa-paperclip"></i>
                            <span>Adjuntar imagen</span>
                        </button>

                        <div class="mode-plus-sep"></div>

                        <button type="button" class="mode-plus-item active" data-value="normal">
                            <span>Normal</span>
                            <small>Respuesta est√°ndar</small>
                        </button>

                        <button type="button" class="mode-plus-item" data-value="step">
                            <span>Tutor paso a paso</span>
                            <small>Explica con pasos</small>
                        </button>

                        <button type="button" class="mode-plus-item" data-value="hints">
                            <span>Solo pistas</span>
                            <small>Gu√≠a sin resolver todo</small>
                        </button>

                        <button type="button" class="mode-plus-item" data-value="result">
                            <span>Solo resultado</span>
                            <small>Respuesta corta</small>
                        </button>
                    </div>

                    <!-- ‚úÖ valor real para backend -->
                    <input type="hidden" id="study-mode" value="normal">
                </div>  <!-- ‚úÖ ESTE CIERRE ES EL QUE FALTABA -->

                <input type="text" id="user-input" placeholder="Escribe un mensaje..." autocomplete="off">

                <button class="send-btn" onclick="enviarMensaje()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <!-- ‚úÖ TOAST / NOTIFICACI√ìN -->
            <div id="toast" class="toast hidden">
                <i class="fa-solid fa-circle-check"></i>
                <span id="toastText">Listo</span>
            </div>
        </main>

        <div id="subjectsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üß≠ Explorar Categor√≠as</h2>
                    <span class="close-modal" onclick="toggleModal('subjectsModal')">&times;</span>
                </div>
                <div class="modal-body">
                    
                    <div class="category-group">
                        <h3>üî¨ Ciencias Exactas</h3>
                        <div class="chips-grid">
                            <button onclick="seleccionarMateria('Matem√°ticas')">Matem√°ticas</button>
                            <button onclick="seleccionarMateria('F√≠sica')">F√≠sica</button>
                            <button onclick="seleccionarMateria('Qu√≠mica')">Qu√≠mica</button>
                            <button onclick="seleccionarMateria('Biolog√≠a')">Biolog√≠a</button>
                            <button onclick="seleccionarMateria('Estad√≠stica')">Estad√≠stica</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <h3>üíª Tecnolog√≠a</h3>
                        <div class="chips-grid">
                            <button onclick="seleccionarMateria('Programaci√≥n')">Programaci√≥n</button>
                            <button onclick="seleccionarMateria('Inteligencia Artificial')">IA</button>
                            <button onclick="seleccionarMateria('Ciberseguridad')">Ciberseguridad</button>
                            <button onclick="seleccionarMateria('Desarrollo Web')">Web Dev</button>
                            <button onclick="seleccionarMateria('Bases de Datos')">Bases de Datos</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <h3>üìö Humanidades</h3>
                        <div class="chips-grid">
                            <button onclick="seleccionarMateria('Historia')">Historia</button>
                            <button onclick="seleccionarMateria('Literatura')">Literatura</button>
                            <button onclick="seleccionarMateria('Filosof√≠a')">Filosof√≠a</button>
                            <button onclick="seleccionarMateria('Geograf√≠a')">Geograf√≠a</button>
                        </div>
                    </div>
                    
                    <div class="category-group">
                        <h3>üíº Negocios</h3>
                        <div class="chips-grid">
                            <button onclick="seleccionarMateria('Econom√≠a')">Econom√≠a</button>
                            <button onclick="seleccionarMateria('Contabilidad')">Contabilidad</button>
                            <button onclick="seleccionarMateria('Marketing')">Marketing</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <h3>üåç Idiomas</h3>
                        <div class="chips-grid">
                            <button onclick="seleccionarMateria('Ingl√©s')">Ingl√©s</button>
                            <button onclick="seleccionarMateria('Franc√©s')">Franc√©s</button>
                            <button onclick="seleccionarMateria('Portugu√©s')">Portugu√©s</button>
                            <button onclick="seleccionarMateria('Italiano')">Italiano</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <h3>üé® Artes y Creatividad</h3>
                        <div class="chips-grid">
                            <button onclick="seleccionarMateria('M√∫sica')">M√∫sica</button>
                            <button onclick="seleccionarMateria('Arte')">Arte</button>
                            <button onclick="seleccionarMateria('Dise√±o')">Dise√±o</button>
                            <button onclick="seleccionarMateria('Fotograf√≠a')">Fotograf√≠a</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <h3>üß† Salud y Bienestar</h3>
                        <div class="chips-grid">
                            <button onclick="seleccionarMateria('Psicolog√≠a')">Psicolog√≠a</button>
                            <button onclick="seleccionarMateria('Nutrici√≥n')">Nutrici√≥n</button>
                            <button onclick="seleccionarMateria('Anatom√≠a')">Anatom√≠a</button>
                            <button onclick="seleccionarMateria('H√°bitos saludables')">H√°bitos</button>
                        </div>
                    </div>

                    <div class="category-group">
                        <h3>‚öñÔ∏è Sociedad y Derecho</h3>
                        <div class="chips-grid">
                            <button onclick="seleccionarMateria('Derecho')">Derecho</button>
                            <button onclick="seleccionarMateria('√âtica')">√âtica</button>
                            <button onclick="seleccionarMateria('Sociolog√≠a')">Sociolog√≠a</button>
                            <button onclick="seleccionarMateria('Civismo')">Civismo</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="overlay" onclick="toggleSidebar()"></div>
    </div>

    <!-- ‚úÖ MODAL: Confirmar eliminaci√≥n de chat -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h2 style="margin:0;">üóëÔ∏è Eliminar conversaci√≥n</h2>
                <span class="close-modal" onclick="cerrarDeleteModal()">&times;</span>
            </div>

            <div class="modal-body">
                <p style="margin-top:0; color: var(--text-dim);">
                    ¬øEst√°s seguro? Esta acci√≥n <b>no se puede deshacer</b>.
                </p>

                <label class="confirm-check">
                    <input type="checkbox" id="deleteCheck">
                    S√≠, estoy seguro de eliminarla.
                </label>
            </div>

            <div class="confirm-actions">
                <button class="btn-cancel" onclick="cerrarDeleteModal()">Cancelar</button>
                <button class="btn-danger" id="btnDeleteConfirm" disabled onclick="confirmarEliminarChat()">
                    Eliminar
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>