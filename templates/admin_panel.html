<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Admin - Nexus</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/nexus-brain.svg') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="admin-page">
    <div class="admin-shell">
        <header class="admin-topbar admin-exec-header">
            <div class="admin-brand">
                <i class="fas fa-shield-alt"></i>
                <div>
                    <h1>Panel de Administracion</h1>
                    <p>
                        Sesion: {{ current_user.name }}
                        {% if admin_role == "super_admin" %}(Super Admin){% else %}(Admin){% endif %}
                    </p>
                </div>
            </div>
            <div class="admin-header-meta">
                <span class="admin-update-pill">
                    <i class="fas fa-clock"></i>
                    Actualizado: <strong id="adminLastUpdated">--:--</strong>
                </span>
                <a class="admin-btn" href="{{ url_for('home') }}"><i class="fas fa-arrow-left"></i> Volver al chat</a>
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <section class="admin-flashes">
                    {% for category, message in messages %}
                        <div class="admin-flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                </section>
            {% endif %}
        {% endwith %}

        <section class="admin-kpi-grid admin-kpi-grid--exec">
            <article class="admin-kpi-card">
                <span>Usuarios totales</span>
                <strong>{{ total_users }}</strong>
            </article>
            <article class="admin-kpi-card">
                <span>Usuarios activos</span>
                <strong>{{ account_status_values[0] if account_status_values|length > 0 else 0 }}</strong>
            </article>
            <article class="admin-kpi-card">
                <span>Usuarios desactivados</span>
                <strong>{{ account_status_values[1] if account_status_values|length > 1 else 0 }}</strong>
            </article>
            <article class="admin-kpi-card">
                <span>Chats</span>
                <strong>{{ total_chats }}</strong>
            </article>
            <article class="admin-kpi-card">
                <span>Mensajes</span>
                <strong>{{ total_messages }}</strong>
            </article>
            <article class="admin-kpi-card">
                <span>Admins activos</span>
                <strong>{{ total_admins }}</strong>
            </article>
        </section>

        <section class="admin-grid-two">
            <article class="admin-panel-card">
                <h2>Accesos rapidos</h2>
                <div class="admin-quick-grid">
                    {% if 'view_users' in admin_permissions %}
                    <a class="admin-quick-card" href="{{ url_for('admin_users_page') }}">
                        <span><i class="fas fa-users"></i> Usuarios</span>
                        <small>Gestionar cuentas y estados</small>
                    </a>
                    {% endif %}
                    {% if 'manage_admins' in admin_permissions %}
                    <a class="admin-quick-card" href="{{ url_for('admin_admins_page') }}">
                        <span><i class="fas fa-user-shield"></i> Administradores</span>
                        <small>Roles, permisos y auditoria</small>
                    </a>
                    {% endif %}
                    {% if 'view_security' in admin_permissions %}
                    <a class="admin-quick-card" href="{{ url_for('admin_security_page') }}">
                        <span><i class="fas fa-lock"></i> Seguridad</span>
                        <small>Intentos, bloqueos y limites</small>
                    </a>
                    {% endif %}
                    {% if 'view_logs' in admin_permissions %}
                    <a class="admin-quick-card" href="{{ url_for('admin_logs_page') }}">
                        <span><i class="fas fa-clipboard-list"></i> Logs</span>
                        <small>Eventos administrativos</small>
                    </a>
                    {% endif %}
                    {% if 'export_reports' in admin_permissions %}
                    <a class="admin-quick-card" href="{{ url_for('admin_reports_page') }}">
                        <span><i class="fas fa-file-export"></i> Reportes</span>
                        <small>PDF y Excel (.xlsx)</small>
                    </a>
                    {% endif %}
                </div>
            </article>

            <article class="admin-panel-card">
                <h2>Estado del sistema</h2>
                <div class="admin-health-list">
                    <div class="admin-health-item">
                        <span>Base de datos</span>
                        <strong class="ok">Conectada</strong>
                    </div>
                    <div class="admin-health-item">
                        <span>Señales de seguridad</span>
                        <strong id="healthSecurityState">Normal</strong>
                    </div>
                    <div class="admin-health-item">
                        <span>Exportaciones</span>
                        <strong class="ok">Disponibles</strong>
                    </div>
                    <div class="admin-health-item">
                        <span>Ratio cuentas activas</span>
                        <strong id="healthActiveRatio">--%</strong>
                    </div>
                </div>
            </article>
        </section>

        <section class="admin-grid-two">
            <article class="admin-panel-card">
                <h2>Top usuarios por chats</h2>
                <p class="admin-chart-note">Muestra los 8 principales y agrupa el resto en “Otros”.</p>
                <div class="admin-chart-box">
                    <canvas id="adminTopChatsChart"></canvas>
                </div>
            </article>
            <article class="admin-panel-card">
                <h2>Mensajes por dia (ultimos 7 dias)</h2>
                <div class="admin-chart-box">
                    <canvas id="adminMessagesByDayChart"></canvas>
                </div>
            </article>
        </section>

        <section class="admin-grid-two">
            <article class="admin-panel-card">
                <h2>Cuentas activas vs desactivadas</h2>
                <div class="admin-chart-box">
                    <canvas id="adminAccountStatusChart"></canvas>
                </div>
            </article>
            <article class="admin-panel-card">
                <h2>Intentos fallidos por IP (top)</h2>
                <div class="admin-chart-box">
                    <canvas id="adminFailedIpChart"></canvas>
                </div>
            </article>
        </section>
    </div>
    <script>
        function _truncateLabel(txt, maxLen) {
            const t = String(txt || "");
            if (t.length <= maxLen) return t;
            return t.slice(0, Math.max(0, maxLen - 1)) + "…";
        }

        function _sum(values) {
            return (values || []).reduce((acc, n) => acc + (Number(n) || 0), 0);
        }

        function _setAdminMeta() {
            const lastUpdatedEl = document.getElementById("adminLastUpdated");
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = new Date().toLocaleString("es-ES");
            }

            const activeValues = {{ account_status_values | tojson }};
            const active = Number(activeValues[0] || 0);
            const inactive = Number(activeValues[1] || 0);
            const total = active + inactive;
            const ratio = total > 0 ? Math.round((active / total) * 100) : 0;
            const ratioEl = document.getElementById("healthActiveRatio");
            if (ratioEl) {
                ratioEl.textContent = ratio + "%";
                ratioEl.className = ratio >= 80 ? "ok" : (ratio >= 50 ? "warn" : "off");
            }

            const failedIpValues = {{ failed_ip_values | tojson }};
            const totalSecuritySignals = _sum(failedIpValues);
            const securityEl = document.getElementById("healthSecurityState");
            if (securityEl) {
                if (totalSecuritySignals >= 40) {
                    securityEl.textContent = "Alta actividad";
                    securityEl.className = "off";
                } else if (totalSecuritySignals >= 15) {
                    securityEl.textContent = "Moderada";
                    securityEl.className = "warn";
                } else {
                    securityEl.textContent = "Normal";
                    securityEl.className = "ok";
                }
            }
        }

        (function(){
            _setAdminMeta();

            const gridColor = "rgba(255,255,255,0.06)";
            const tickColor = "#9fb0c8";

            const topChartEl = document.getElementById("adminTopChatsChart");
            if (topChartEl) {
                const rawLabels = {{ top_chat_labels | tojson }};
                const rawValues = {{ top_chat_values | tojson }};
                const maxBars = 8;

                let labels = rawLabels.slice(0, maxBars);
                let values = rawValues.slice(0, maxBars).map(v => Number(v || 0));
                if (rawLabels.length > maxBars) {
                    labels.push("Otros");
                    values.push(_sum(rawValues.slice(maxBars)));
                }

                if (labels.length) {
                    new Chart(topChartEl, {
                        type: "bar",
                        data: {
                            labels: labels,
                            datasets: [{
                                label: "Chats",
                                data: values,
                                borderRadius: 8,
                                backgroundColor: "rgba(56, 189, 248, 0.75)",
                                borderColor: "rgba(14, 165, 233, 1)",
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: "y",
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        title: function(items) {
                                            const i = items?.[0]?.dataIndex ?? 0;
                                            return labels[i] || "";
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: tickColor, precision: 0 },
                                    grid: { color: gridColor },
                                    beginAtZero: true
                                },
                                y: {
                                    ticks: {
                                        color: tickColor,
                                        callback: function(value, index) {
                                            return _truncateLabel(labels[index], 22);
                                        }
                                    },
                                    grid: { color: gridColor }
                                }
                            }
                        }
                    });
                }
            }

            const dayChartEl = document.getElementById("adminMessagesByDayChart");
            if (dayChartEl) {
                const rawLabels = {{ message_day_labels | tojson }};
                const labels = rawLabels.map(d => {
                    const parts = String(d).split("-");
                    if (parts.length !== 3) return d;
                    return parts[2] + "/" + parts[1];
                });
                const values = {{ message_day_values | tojson }};
                new Chart(dayChartEl, {
                    type: "line",
                    data: {
                        labels,
                        datasets: [{
                            label: "Mensajes",
                            data: values,
                            borderColor: "#22d3ee",
                            backgroundColor: "rgba(34,211,238,0.15)",
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: tickColor } }
                        },
                        scales: {
                            x: { ticks: { color: tickColor }, grid: { color: gridColor } },
                            y: { ticks: { color: tickColor, precision: 0 }, grid: { color: gridColor }, beginAtZero: true }
                        }
                    }
                });
            }

            const accountChartEl = document.getElementById("adminAccountStatusChart");
            if (accountChartEl) {
                const labels = {{ account_status_labels | tojson }};
                const values = {{ account_status_values | tojson }};
                new Chart(accountChartEl, {
                    type: "doughnut",
                    data: {
                        labels,
                        datasets: [{
                            data: values,
                            backgroundColor: ["#22c55e", "#ef4444"],
                            borderColor: ["#16a34a", "#dc2626"],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: tickColor } }
                        }
                    }
                });
            }

            const failedChartEl = document.getElementById("adminFailedIpChart");
            if (failedChartEl) {
                const labels = {{ failed_ip_labels | tojson }};
                const values = {{ failed_ip_values | tojson }};
                if (labels.length) {
                    new Chart(failedChartEl, {
                        type: "bar",
                        data: {
                            labels,
                            datasets: [{
                                label: "Intentos",
                                data: values,
                                borderRadius: 8,
                                backgroundColor: "#f97316"
                            }]
                        },
                        options: {
                            indexAxis: "y",
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: tickColor, precision: 0 }, grid: { color: gridColor }, beginAtZero: true },
                                y: {
                                    ticks: {
                                        color: tickColor,
                                        callback: function(value, index) {
                                            return _truncateLabel(labels[index], 22);
                                        }
                                    },
                                    grid: { color: gridColor }
                                }
                            }
                        }
                    });
                }
            }
        })();
    </script>
</body>
</html>
